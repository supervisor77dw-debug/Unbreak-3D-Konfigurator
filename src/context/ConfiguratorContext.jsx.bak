
import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { broadcastConfig, initConfigurationListener } from '../utils/iframeBridge';

const ConfiguratorContext = createContext();

export const CONFIGURATION_DEFAULTS = {
    variant: 'glass_holder', // 'glass_holder' | 'bottle_holder'
    pattern: {
        enabled: true, // Always active
        type: 'windrose',
    },
    colors: {
        base: 'black',
        arm: 'black',
        module: 'black',
        pattern: 'red', // Premium default
    },
    finish: 'matte', // 'matte' | 'glossy'
    quantity: 1,
};

export const COLOR_PALETTE = {
    mint: '#a2d9ce',
    green: '#145a32',
    purple: '#4a235a',
    iceBlue: '#5499c7',
    darkBlue: '#1b2631',
    red: '#b03a2e',
    black: '#121212',
};

// SKU mapping
const PRODUCT_SKU_MAP = {
    glass_holder: 'UNBREAK-GLAS-01',
    bottle_holder: 'UNBREAK-FLASCHE-01',
};

export const ConfiguratorProvider = ({ children }) => {
    const [variant, setVariant] = useState(CONFIGURATION_DEFAULTS.variant);
    const [pattern, setPattern] = useState(CONFIGURATION_DEFAULTS.pattern);
    const [colors, setColors] = useState(CONFIGURATION_DEFAULTS.colors);
    const [finish, setFinish] = useState(CONFIGURATION_DEFAULTS.finish);
    const [quantity, setQuantity] = useState(CONFIGURATION_DEFAULTS.quantity);
    const [previewImageUrl, setPreviewImageUrl] = useState(null);
    const [engraving, setEngraving] = useState(null);

    /**
     * Get current configuration in parent-expected format
     * Product-aware mapping:
     * - glass_holder: { base, arm, module, pattern } (4 parts REQUIRED)
     * - bottle_holder: { base, pattern } (only 2 parts)
     */
    const getCurrentConfig = useCallback(() => {
        const isBottleHolder = variant === 'bottle_holder';
        
        // Build colors object based on product type
        const colorConfig = isBottleHolder 
            ? {
                // BOTTLE HOLDER: Only base (Unterteil) and pattern (Oberteil/Farbakzent)
                base: 'black',             // Unterteil (fixed black in 3D model)
                pattern: colors.pattern,   // Oberteil/Farbakzent (konfigurierbar)
              }
            : {
                // GLASS HOLDER: ALL 4 PARTS (REQUIRED)
                base: colors.base,         // Grundplatte
                arm: colors.arm,           // Arm
                module: colors.module,     // Gummilippe/Modul
                pattern: colors.pattern,   // Windrose/Pattern
              };
        
        // Build parts metadata
        const partsMetadata = isBottleHolder
            ? [
                { key: 'base', label_de: 'Unterteil', editable: false },
                { key: 'pattern', label_de: 'Oberteil/Farbakzent', editable: true },
              ]
            : [
                { key: 'base', label_de: 'Grundplatte', editable: true },
                { key: 'arm', label_de: 'Arm', editable: true },
                { key: 'module', label_de: 'Gummilippe', editable: true },
                { key: 'pattern', label_de: 'Windrose', editable: true },
              ];
        
        return {
            product: variant,
            product_sku: PRODUCT_SKU_MAP[variant] || 'UNBREAK-UNKNOWN',
            colors: colorConfig,
            parts: partsMetadata,
            finish: finish,
            quantity: quantity,
            preview_image_url: previewImageUrl,
            engraving: engraving,
        };
    }, [colors, finish, quantity, variant, previewImageUrl, engraving]);

    /**
     * Update color and broadcast change to parent
     */
    const updateColor = useCallback((part, colorName) => {
        setColors((prev) => {
            const newColors = {
                ...prev,
                [part]: colorName,
            };
            
            // Broadcast immediately after state update (next tick)
            // Use getCurrentConfig to ensure correct product-aware format
            setTimeout(() => {
                const isBottleHolder = variant === 'bottle_holder';
                
                const colorConfig = isBottleHolder 
                    ? {
                        base: 'black',
                        pattern: newColors.pattern,
                      }
                    : {
                        base: newColors.base,
                        arm: newColors.arm,
                        module: newColors.module,
                        pattern: newColors.pattern,
                      };
                
                const partsMetadata = isBottleHolder
                    ? [
                        { key: 'base', label_de: 'Unterteil', editable: false },
                        { key: 'pattern', label_de: 'Oberteil/Farbakzent', editable: true },
                      ]
                    : [
                        { key: 'base', label_de: 'Grundplatte', editable: true },
                        { key: 'arm', label_de: 'Arm', editable: true },
                        { key: 'module', label_de: 'Gummilippe', editable: true },
                        { key: 'pattern', label_de: 'Windrose', editable: true },
                      ];
                
                const config = { with correct product-aware format
        setTimeout(() => {
            const isBottleHolder = newVariant === 'bottle_holder';
            
            const colorConfig = isBottleHolder 
                ? {
                    base: 'black',
                    top: colors.pattern,
                  }
                : {
                    base: colors.base,
                    middle: colors.arm,
                    top: colors.pattern,
                  };
            
            const partsMetadata = isBottleHolder
                ? [
                    { key: 'base', label_de: 'Unterteil', editable: false },
                    { key: 'top', label_de: 'Oberteil/Farbakzent', editable: true },
                  ]
                : [
                    { key: 'base', label_de: 'Grundplatte', editable: true },
                    { key: 'middle', label_de: 'Arm', editable: true },
                    { key: 'top', label_de: 'Windrose', editable: true },
                    { key: 'lip', label_de: 'Gummilippe', editable: true, internal_only: true },
                  ];
            
            const config = {
                product: newVariant,
                product_sku: PRODUCT_SKU_MAP[newVariant] || 'UNBREAK-UNKNOWN',
                colors: colorConfig,
                parts: partsMetadata,
                finish: finish,
                quantity: quantity,
                preview_image_url: previewImageUrl,
                engraving: engraving,
            };
            
            broadcastConfig(config, `variant_changed:${newVariant}`);
        }, 0);
    }, [colors, finish, quantity, previewImageUrl, engravinview_image_url: previewImageUrl,
                    engraving: engraving,
                };
                
                broadcastConfig(config, `color_changed:${part}=${colorName}`);
            }, 0);
            
            return newColors;
        });
    }, [finish, quantity, variant, previewImageUrl, engraving]);

    /**
     * Update variant and broadcast change to parent
     */
    const updateVariant = useCallback((newVariant) => {
        setVariant(newVariant);
        
        // Broadcast immediately after state update
        setTimeout(() => {
            const config = getCurrentConfig();
            config.product = newVariant;
            config.product_sku = PRODUCT_SKU_MAP[newVariant] || 'UNBREAK-UNKNOWN';
            broadcastConfig(config, `variant_changed:${newVariant}`);
        }, 0);
    }, [getCurrentConfig]);

    /**
     * Update finish and broadcast change to parent
     */
    const updateFinish = useCallback((newFinish) => {
        setFinish(newFinish);
        
        setTimeout(() => {
            const config = getCurrentConfig();
            config.finish = newFinish;
            broadcastConfig(config, `finish_changed:${newFinish}`);
        }, 0);
    }, [getCurrentConfig]);

    /**
     * Update quantity and broadcast change to parent
     */
    const updateQuantity = useCallback((newQuantity) => {
        setQuantity(newQuantity);
        
        setTimeout(() => {
            const config = getCurrentConfig();
            config.quantity = newQuantity;
            broadcastConfig(config, `quantity_changed:${newQuantity}`);
        }, 0);
    }, [getCurrentConfig]);

    // Initialize GET_CONFIGURATION listener on mount
    useEffect(() => {
        console.info('[ConfiguratorContext] Initializing GET_CONFIGURATION listener');
        const cleanup = initConfigurationListener(getCurrentConfig);
        
        return cleanup;
    }, [getCurrentConfig]);

    return (
        <ConfiguratorContext.Provider
            value={{
                variant,
                setVariant: updateVariant,
                pattern,
                colors,
                updateColor,
                finish,
                setFinish: updateFinish,
                quantity,
                setQuantity: updateQuantity,
                previewImageUrl,
                setPreviewImageUrl,
                engraving,
                setEngraving,
                palette: COLOR_PALETTE,
                getCurrentConfig,
            }}
        >
            {children}
        </ConfiguratorContext.Provider>
    );
};

export const useConfigurator = () => useContext(ConfiguratorContext);
