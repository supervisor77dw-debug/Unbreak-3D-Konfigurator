<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Parent Language Switch</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #718096;
            font-size: 14px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        button {
            flex: 1;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        .btn-de {
            background: #fc8181;
            color: white;
        }
        .btn-en {
            background: #4299e1;
            color: white;
        }
        .btn-handshake {
            background: #48bb78;
            color: white;
        }
        .btn-clear {
            background: #cbd5e0;
            color: #2d3748;
        }
        .log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .log-entry {
            margin-bottom: 4px;
            padding: 4px;
            border-left: 3px solid transparent;
        }
        .log-entry.sent {
            border-left-color: #4299e1;
        }
        .log-entry.received {
            border-left-color: #48bb78;
        }
        .log-entry.error {
            border-left-color: #fc8181;
            color: #fc8181;
        }
        .iframe-container {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        iframe {
            width: 100%;
            height: 700px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            flex: 1;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #cbd5e0;
        }
        .status-item.active {
            border-left-color: #48bb78;
            background: #f0fff4;
        }
        .status-label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .status-value {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Language Switch Test (Parent)</h1>
            <p class="subtitle">Test the language switching mechanism between parent and iframe configurator</p>
        </div>

        <div class="controls">
            <div class="status">
                <div class="status-item" id="status-de">
                    <div class="status-label">German (DE)</div>
                    <div class="status-value" id="count-de">0</div>
                </div>
                <div class="status-item" id="status-en">
                    <div class="status-label">English (EN)</div>
                    <div class="status-value" id="count-en">0</div>
                </div>
                <div class="status-item" id="status-ack">
                    <div class="status-label">ACK Received</div>
                    <div class="status-value" id="count-ack">0</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-de" onclick="switchLanguage('de')">üá©üá™ Switch to GERMAN</button>
                <button class="btn-en" onclick="switchLanguage('en')">üá¨üáß Switch to ENGLISH</button>
            </div>

            <div class="button-group">
                <button class="btn-handshake" onclick="sendHandshake()">ü§ù Send Handshake</button>
                <button class="btn-clear" onclick="clearLog()">üóëÔ∏è Clear Log</button>
            </div>

            <div class="log" id="log"></div>
        </div>

        <div class="iframe-container">
            <iframe 
                id="configurator" 
                src="http://localhost:5173"
                title="3D Configurator"
            ></iframe>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let countDE = 0;
        let countEN = 0;
        let countACK = 0;
        let correlationCounter = 0;

        // ============================================
        // LOGGING
        // ============================================
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                fractionalSecondDigits: 3 
            });
            
            entry.textContent = `[${timestamp}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        function updateStatus(lang) {
            if (lang === 'de') {
                countDE++;
                document.getElementById('count-de').textContent = countDE;
                document.getElementById('status-de').classList.add('active');
                document.getElementById('status-en').classList.remove('active');
            } else if (lang === 'en') {
                countEN++;
                document.getElementById('count-en').textContent = countEN;
                document.getElementById('status-en').classList.add('active');
                document.getElementById('status-de').classList.remove('active');
            }
        }

        function updateACKStatus() {
            countACK++;
            document.getElementById('count-ack').textContent = countACK;
            document.getElementById('status-ack').classList.add('active');
            setTimeout(() => {
                document.getElementById('status-ack').classList.remove('active');
            }, 1000);
        }

        // ============================================
        // MESSAGE SENDING
        // ============================================
        function switchLanguage(lang) {
            const iframe = document.getElementById('configurator');
            if (!iframe.contentWindow) {
                log('‚ùå ERROR: iframe not loaded', 'error');
                return;
            }

            correlationCounter++;
            const correlationId = `lang-switch-${Date.now()}-${correlationCounter}`;

            const message = {
                type: 'UNBREAK_SET_LANG',
                lang: lang,
                correlationId: correlationId
            };

            // Send message
            iframe.contentWindow.postMessage(message, 'http://localhost:5173');
            
            log(`üì§ SENT: UNBREAK_SET_LANG lang=${lang} correlationId=${correlationId}`, 'sent');
            updateStatus(lang);
        }

        function sendHandshake() {
            const iframe = document.getElementById('configurator');
            if (!iframe.contentWindow) {
                log('‚ùå ERROR: iframe not loaded', 'error');
                return;
            }

            const message = {
                type: 'UNBREAK_ONE_PARENT_HELLO',
                origin: window.location.origin
            };

            iframe.contentWindow.postMessage(message, 'http://localhost:5173');
            log(`üì§ SENT: UNBREAK_ONE_PARENT_HELLO`, 'sent');
        }

        // ============================================
        // MESSAGE RECEIVING
        // ============================================
        window.addEventListener('message', (event) => {
            // Log all incoming messages
            const payloadKeys = event.data ? Object.keys(event.data).join(',') : 'N/A';
            console.log('[PARENT][MSG_IN]', event.data);

            // Handle UNBREAK_LANG_ACK
            if (event.data?.type === 'UNBREAK_LANG_ACK') {
                const lang = event.data.lang;
                const correlationId = event.data.correlationId || 'N/A';
                
                log(`‚úÖ ACK received: lang=${lang} correlationId=${correlationId}`, 'received');
                updateACKStatus();
                return;
            }

            // Handle UNBREAK_ONE_CHILD_READY
            if (event.data?.type === 'UNBREAK_ONE_CHILD_READY') {
                log(`‚úÖ Child ready (handshake successful)`, 'received');
                return;
            }

            // Handle UNBREAK_CONFIG_READY
            if (event.data?.type === 'UNBREAK_CONFIG_READY') {
                log(`‚úÖ Configurator ready`, 'received');
                return;
            }

            // Handle other messages
            if (event.data?.type) {
                log(`üì• RECEIVED: ${event.data.type} (${payloadKeys})`, 'received');
            }
        });

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('load', () => {
            log('üöÄ Test page loaded', 'info');
            log('üìç Listening for messages from: http://localhost:5173', 'info');
            log('', 'info');
            log('INSTRUCTIONS:', 'info');
            log('1. Click "Switch to GERMAN" or "Switch to ENGLISH"', 'info');
            log('2. Watch the iframe UI change within 1 second', 'info');
            log('3. Check for ACK in log (should appear immediately)', 'info');
            log('4. Open DevTools Console in iframe to see [IFRAME] logs', 'info');
        });

        // Auto-handshake after iframe loads
        setTimeout(() => {
            sendHandshake();
        }, 2000);
    </script>
</body>
</html>
